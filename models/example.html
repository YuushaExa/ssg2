<title>Chat AI</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  /* Optimized CSS */
  .chat-container {
    width: 100%;
    max-width: 821px;
    margin: auto;
    padding: 10px;
    border-radius: 10px;
  }

  .messages-container {
    overflow-y: auto;
    margin-bottom: 10px;
    max-height: 70vh;
  }

  .chat-form {
    position: relative;
  }

  .input-textarea {
    width: 100%;
    height: 50px;
    padding: 10px;
    border: 1px solid #d4dbe9;
    border-radius: 7px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    background-color: #fff;
  }

  .buttons-container {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    justify-content: flex-end;
  }

  .btn {
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    transition: opacity 0.2s;
    font-size: 14px;
  }

  .btn-primary {
    background-color: #007bff;
    color: #fff;
  }

  .btn-danger {
    background-color: #dc3545;
    color: #fff;
  }

  .btn-secondary {
    background-color: #6c757d;
    color: #fff;
  }

  .message {
    max-width: 90%;
    padding: 8px 12px;
    margin: 8px 0;
    border-radius: 12px;
    word-break: break-word;
  }

  .user-message {
    background-color: #eff6ff;
    margin-left: auto;
  }

  .model-message {
    background-color: #f5f5f5;
  }

  .input-list {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    margin-right: auto;
  }
</style>

<div class="chat-container">
  <div class="messages-container" role="log" aria-live="polite"></div>
  <form class="chat-form">
    <textarea 
      class="input-textarea"
      placeholder="Enter your prompt here..."
      aria-label="Chat input"
    ></textarea>
    <div class="buttons-container">
      <select class="input-list" aria-label="Prompt templates">
        <option value="">Templates</option>
        <option value="Fix Grammar - ">Fix Grammar</option>
        <option value="What is ">What is</option>
        <option value="Top 10 anime">Top 10 anime</option>
        <option value="Explain like I'm 5: ">Explain like I'm 5</option>
        <option value="Summarize this: ">Summarize this</option>
        <option value="Continue ">Continue</option>
      </select>
      <button type="button" class="btn btn-secondary" aria-label="Clear chat">Clear</button>
      <button type="submit" class="btn btn-primary" aria-label="Send message">Run</button>
    </div>
  </form>
</div>

<script>
(function() {
  'use strict';
  
  const dom = {
    messagesContainer: document.querySelector('.messages-container'),
    chatForm: document.querySelector('.chat-form'),
    inputText: document.querySelector('.input-textarea'),
    clearBtn: document.querySelector('.btn-secondary'),
    templateSelect: document.querySelector('.input-list')
  };

  let chatHistory = [];
  let isStreaming = false;

  marked.setOptions({
    highlight: (code, lang) => hljs.highlight(code, { 
      language: hljs.getLanguage(lang) ? lang : 'plaintext' 
    }).value
  });

  function addMessage(role, content) {
    chatHistory.push({ role, parts: [{ text: content }] });
    if (!isStreaming) renderMessages();
  }

  function renderMessages() {
    dom.messagesContainer.innerHTML = chatHistory.map(msg => `
      <div class="message ${msg.role}-message" role="${msg.role}">
        ${msg.role === 'model' ? marked.parse(msg.parts[0].text) : msg.parts[0].text}
      </div>
    `).join('');
    
    dom.messagesContainer.querySelectorAll('pre code').forEach(hljs.highlightBlock);
    dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const prompt = dom.inputText.value.trim();
    if (!prompt || isStreaming) return;

    const submitBtn = dom.chatForm.querySelector('[type="submit"]');
    submitBtn.disabled = true;
    
    try {
      addMessage('user', prompt);
      dom.inputText.value = '';
      
      const response = await fetch('https://chatai-flame-eta.vercel.app/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chatHistory })
      });

      if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
      
      await streamResponse(response);
    } catch(err) {
      console.error('Fetch error:', err);
      addMessage('model', `Error: ${err.message}`);
    } finally {
      submitBtn.disabled = false;
      isStreaming = false;
    }
  }

  async function streamResponse(response) {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    isStreaming = true;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const chunks = buffer.split('\n\n');
      buffer = chunks.pop();

      for (const chunk of chunks) {
        const [type, data] = chunk.split(':');
        if (type.trim() === 'data') {
          const { text } = JSON.parse(data.trim());
          chatHistory[chatHistory.length - 1].parts[0].text += text;
          renderMessages();
        }
      }
    }
  }

  dom.chatForm.addEventListener('submit', handleSubmit);
  dom.clearBtn.addEventListener('click', () => {
    chatHistory = [];
    renderMessages();
  });
  dom.templateSelect.addEventListener('change', () => {
    dom.inputText.value = dom.templateSelect.value;
  });
  dom.inputText.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      dom.chatForm.requestSubmit();
    }
  });
})();
</script>
