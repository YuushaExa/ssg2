<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat AI</title>
  <link
    href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/atom-one-dark.min.css"
    rel="stylesheet"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Combined and Minified CSS */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.3;
      color: #333;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #fff;
      margin: 0;
    }

    .chat-container {
      width: 100%;
      max-width: 821px;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .messages-container {
      overflow-y: auto;
      max-height: 70vh;
      padding: 10px;
      border: 1px solid #d4dbe9;
      border-radius: 7px;
      background-color: #f9f9f9;
    }

    .input-textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      border: 1px solid #d4dbe9;
      border-radius: 7px;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      outline: none;
      background-color: #fff;
    }

    .buttons-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .run-button,
    .clear-button {
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 14px;
    }

    .run-button {
      background-color: #007bff;
      color: #fff;
    }

    .run-button:hover,
    .run-button:disabled {
      background-color: #0056b3;
    }

    .clear-button {
      background-color: #6c757d;
      color: #fff;
    }

    .clear-button:hover {
      background-color: #5a6268;
    }

    .user-message {
      width: max-content;
      max-width: 80%;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #eff6ff;
      border-radius: 15px;
      align-self: flex-end;
    }

    .model-message {
      width: max-content;
      max-width: 80%;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f5f5f5;
      border-radius: 15px;
      align-self: flex-start;
    }

    .input-list-container {
      flex-grow: 1;
    }

    .input-list {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="messages-container"></div>
    <textarea
      class="input-textarea"
      placeholder="Enter your prompt here..."
    ></textarea>
    <div class="buttons-container">
      <div class="input-list-container">
        <select class="input-list">
          <option value="">Select a Prompt</option>
          <option value="Fix Grammar - ">Fix Grammar</option>
          <option value="What is ">What is</option>
          <option value="Top 10 anime">Top 10 anime</option>
          <option value="Explain like I'm 5: ">Explain like I'm 5</option>
          <option value="Summarize this: ">Summarize this</option>
          <option value="Continue ">Continue</option>
        </select>
      </div>
      <button class="run-button">Run</button>
      <button class="clear-button">Clear</button>
    </div>
  </div>

  <script>
    (function () {
      // --- Initialize Libraries ---
      marked.setOptions({
        highlight: function (code, language) {
          const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
          return hljs.highlight(code, { language: validLanguage }).value;
        },
      });

      // --- DOM Elements ---
      const messagesContainer = document.querySelector('.messages-container');
      const inputTextArea = document.querySelector('.input-textarea');
      const runButton = document.querySelector('.run-button');
      const clearButton = document.querySelector('.clear-button');
      const inputListSelect = document.querySelector('.input-list');

      // --- Chat State ---
      let chatHistory = [];
      let isStreaming = false;

      // --- Helper Functions ---
      function addMessageToChat(role, content) {
        chatHistory.push({ role, parts: [{ text: content }] });
        renderChat();
      }

      function renderChat() {
        messagesContainer.innerHTML = chatHistory
          .map((message) => {
            const isUser = message.role === 'user';
            const content = isUser
              ? message.parts[0].text
              : marked.parse(message.parts[0].text);
            return `
              <div class="${isUser ? 'user-message' : 'model-message'}">
                ${content}
              </div>
            `;
          })
          .join('');

        // Apply syntax highlighting
        messagesContainer.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);
        });

        // Scroll to the bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      async function fetchModelResponse(prompt) {
        try {
          const response = await fetch('https://chatai-flame-eta.vercel.app/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatHistory }),
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let accumulatedResponse = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const textChunk = decoder.decode(value);
            const dataChunks = textChunk
              .split('\n\n')
              .filter((chunk) => chunk.trim() !== '');

            for (const dataChunk of dataChunks) {
              if (dataChunk.startsWith('data:')) {
                const jsonData = JSON.parse(dataChunk.substring(5).trim());
                if (jsonData.text) {
                  accumulatedResponse += jsonData.text;
                  renderChat();
                }
              }
            }
          }

          addMessageToChat('model', accumulatedResponse);
        } catch (error) {
          console.error('Error:', error);
          addMessageToChat('model', `Error: ${error.message}`);
        } finally {
          isStreaming = false;
        }
      }

      // --- Event Listeners ---
      runButton.addEventListener('click', async () => {
        const prompt = inputTextArea.value.trim();
        if (!prompt) return alert('Please enter a prompt.');

        isStreaming = true;
        runButton.disabled = true;
        runButton.textContent = 'Running...';

        await fetchModelResponse(prompt);

        runButton.disabled = false;
        runButton.textContent = 'Run';
        inputTextArea.value = '';
      });

      clearButton.addEventListener('click', () => {
        chatHistory = [];
        renderChat();
      });

      inputListSelect.addEventListener('change', () => {
        inputTextArea.value = inputListSelect.value;
      });
    })();
  </script>
</body>
</html>
